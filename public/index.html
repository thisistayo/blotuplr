<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>Upload an Image</h1>
        <form @submit.prevent="uploadImage">
            <input type="file" @change="handleFileChange" accept="image/*" required>
            <input v-model="themePath" placeholder="Enter theme path (e.g., flowers/wild)" required>
            <button type="submit">Upload</button>
        </form>
        <p v-if="message" :class="{ error: isError }">{{ message }}</p>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const themePath = ref('');
                const file = ref(null);
                const message = ref('');
                const isError = ref(false);
                const availableThemes = ref([]);

                const fetchThemes = async () => {
                    try {
                        const response = await axios.get('/api/themes');
                        availableThemes.value = response.data;
                    } catch (error) {
                        console.error('Error fetching themes:', error);
                        setMessage('Failed to fetch themes. Some features may be limited.', true);
                    }
                };

                const handleFileChange = (event) => {
                    file.value = event.target.files[0];
                };

                const uploadImage = async () => {
                    if (!file.value) {
                        setMessage('Please select a file to upload.', true);
                        return;
                    }

                    if (!themePath.value) {
                        setMessage('Please enter a theme path.', true);
                        return;
                    }

                    if (!availableThemes.value.includes(themePath.value)) {
                        setMessage('The entered theme does not exist. Please enter a valid theme path.', true);
                        return;
                    }

                    const formData = new FormData();
                    formData.append('image', file.value);
                    formData.append('theme', themePath.value);

                    try {
                        const response = await axios.post('/api/upload', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });
                        setMessage(response.data.message, false);
                        // Reset form
                        file.value = null;
                        themePath.value = '';
                    } catch (error) {
                        console.error('Error uploading image:', error);
                        setMessage(error.response?.data?.error || 'Failed to upload image. Please try again.', true);
                    }
                };

                const setMessage = (msg, error = false) => {
                    message.value = msg;
                    isError.value = error;
                };

                onMounted(() => {
                    fetchThemes();
                });

                return {
                    themePath,
                    message,
                    isError,
                    handleFileChange,
                    uploadImage
                };
            }
        }).mount('#app');
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        input, button {
            padding: 10px;
            font-size: 16px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .error {
            color: red;
        }
    </style>
</body>
</html>